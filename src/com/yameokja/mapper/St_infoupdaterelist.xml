<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yameokja.mc.IStinfoUpdaterelistDAO">
	<select id="count_relist" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
			    FROM (
			        SELECT RP.FINAL_DATE AS FINAL_DATE
		    , CASE WHEN OA.REG_DATE IS NOT NULL THEN '○'
		        ELSE 'x'
		        END AS OBJYN
		    , CASE WHEN PT.PEN_TYPE_NUM IS NOT NULL THEN '○'
		        ELSE 'x'
		        END AS PTYN
		    , ROW_NUMBER() OVER (ORDER BY RP.FINAL_DATE DESC) AS RNUM
		FROM REQ_APPLY RA
		LEFT JOIN REQ_PROCESS RP ON RA.REQ_APPLY_NUM = RP.REQ_APPLY_NUM
		RIGHT JOIN ST_CHBOX SC ON RA.ST_CHBOX_NUM = SC.ST_CHBOX_NUM
		LEFT JOIN PENALTY PT ON RP.REQ_PROCESS_NUM = PT.REQ_PROCESS_NUM
		LEFT JOIN PEN_TYPE_LABEL PTL ON PT.PEN_TYPE_NUM = PTL.PEN_TYPE_NUM
		LEFT JOIN ST_LIST SL ON SC.ST_NUM = SL.ST_NUM
		LEFT JOIN IN_PROCESS IP ON SL.IN_PROCESS_NUM = IP.IN_PROCESS_NUM
		RIGHT JOIN IN_APPLY IA ON IP.IN_APPLY_NUM = IA.IN_APPLY_NUM
		LEFT JOIN OBJ_APPLY OA ON RP.REQ_PROCESS_NUM = OA.REQ_PROCESS_NUM
		WHERE IA.USER_NUM = #{user_num}
	    )
	</select>

	<select id="stinfoupdatelist" resultType="com.yameokja.mc.StinfoUpdaterelistDTO">
	    SELECT REQ_APPLY_NUM, ST_NAME, FINAL_DATE, REG_DATE, CHECK_LABEL, RNUM                                  
		FROM(
		    SELECT RAV.REQ_APPLY_NUM AS REQ_APPLY_NUM, RAV.ST_NAME AS ST_NAME, TO_CHAR(RP.FINAL_DATE, 'YYYY-MM-DD') AS FINAL_DATE,
                  TO_CHAR(RAV.REG_DATE, 'YYYY-MM-DD') AS REG_DATE,
		        CASE WHEN OA.OBJ_APPLY_NUM IS NULL
		                  AND TO_DATE(RP.FINAL_DATE, 'YYYY-MM-DD') + INTERVAL '3' DAY > TO_DATE(SYSDATE, 'YYYY-MM-DD') THEN '둘다가능'
		             WHEN OBR.OBJ_REJ_NUM IS NOT NULL THEN '패널티회수가능'                
		             ELSE '둘다불가능'
		        END AS CHECK_LABEL,
		        ROW_NUMBER() OVER (ORDER BY RP.FINAL_DATE DESC) AS RNUM
		    FROM REQ_APPLY_VIEW RAV
		    RIGHT JOIN REQ_PROCESS RP
		        ON RAV.REQ_APPLY_NUM = RP.REQ_APPLY_NUM
		        LEFT JOIN OBJ_APPLY OA
		        ON RP.REQ_PROCESS_NUM = OA.REQ_PROCESS_NUM
		        LEFT JOIN OBJ_PROCESS OP
		        ON OA.OBJ_APPLY_NUM = OP.OBJ_APPLY_NUM
		        LEFT JOIN OBJ_REJ OBR
		        ON OP.OBJ_PROCESS_NUM = OBR.OBJ_PROCESS_NUM
		        LEFT JOIN PENALTY P
		        ON RP.REQ_PROCESS_NUM = P.REQ_PROCESS_NUM
		        LEFT JOIN REVO_APPLY RA
		        ON P.PEN_GRANT_NUM = RA.PEN_GRANT_NUM
		        WHERE RP.REQ_PROCESS_NUM NOT IN (SELECT REQ_PROCESS_NUM
		                                      FROM REQ_REJ)
		) T
		WHERE  RNUM BETWEEN #{startRow} AND #{endRow}
		                                  
	</select>
</mapper>